{% extends 'base.html' %}

{% block content %}

<div class="container mt-5">

    <!-- Elemento nascosto per contenere i dati JSON in modo sicuro -->
    <div id="scambi-json-data" style="display: none;">{{ scambi|tojson }}</div>

    <!-- HEADER CON TITOLO -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <div>
            <h1 class="mb-0">Mercato - {{ nome_squadra }}</h1>
            <small class="text-muted">
                Crediti totali: <strong>{{ crediti }}</strong> |
                Crediti disponibili:
                <strong
                    {% if offerta_massima_possibile <= 0 %}
                        class="text-danger"
                    {% elif offerta_massima_possibile < 10 %}
                        class="text-warning"
                    {% else %}
                        class="text-success"
                    {% endif %}
                >
                    {{ offerta_massima_possibile }}
                </strong>
            </small>
        </div>
        <a href="{{ url_for('mercato.nuovo_scambio', nome_squadra=nome_squadra) }}"
           class="btn btn-primary btn-lg mt-2 mt-sm-0">
            Nuova proposta di scambio
        </a>
    </div>

    <!-- SEZIONE: SCAMBI PROPOSTI DA ME -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">Scambi proposti da me</div>
        <div class="card-body table-responsive bg-light">
            <table class="table table-striped table-hover align-middle" data-action-url="{{ url_for('mercato.user_mercato', nome_squadra=nome_squadra) }}">
                <thead class="table-light">
                    <tr>
                        <th>Data</th>
                        <th>Squadra destinataria</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for scambio in scambi if scambio.squadra_proponente == nome_squadra and scambio.stato == 'in_attesa' %}
                    <tr class="proposal-row" data-scambio-id="{{ scambio.id }}">
                        <td>{{ scambio.data_proposta.strftime('%d/%m/%Y') }}</td>
                        <td>{{ scambio.squadra_destinataria }}</td>
                        <td class="text-center"><button type="button" class="btn btn-xs btn-outline-secondary view-proposal-btn">Vedi</button></td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" class="text-center text-muted">Nessuna proposta di scambio attiva</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- SEZIONE: SCAMBI RICEVUTI -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-warning text-dark">Scambi ricevuti</div>
        <div class="card-body table-responsive bg-light">
            <table class="table table-striped table-hover align-middle" data-action-url="{{ url_for('mercato.user_mercato', nome_squadra=nome_squadra) }}">
                <thead class="table-light">
                    <tr>
                        <th>Data</th>
                        <th>Proponente</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for scambio in scambi if scambio.squadra_destinataria == nome_squadra and scambio.stato == 'in_attesa' %}
                     <tr class="proposal-row" data-scambio-id="{{ scambio.id }}">
                        <td>{{ scambio.data_proposta.strftime('%d/%m/%Y') }}</td>
                        <td>{{ scambio.squadra_proponente }}</td>
                        <td class="text-center"><button type="button" class="btn btn-xs btn-outline-secondary view-proposal-btn">üëÅÔ∏è Vedi</button></td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" class="text-center text-muted">Nessuno scambio ricevuto</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- SEZIONE: STORICO SCAMBI -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-secondary text-white">Storico Scambi</div>
        <div class="card-body table-responsive">
            <table class="table table-striped table-hover align-middle" data-action-url="{{ url_for('mercato.user_mercato', nome_squadra=nome_squadra) }}">
                <thead class="table-light">
                    <tr>
                        <th>Data</th>
                        <th>Controparte</th>
                        <th>Stato</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for scambio in scambi if scambio.stato in ['accettato', 'rifiutato', 'annullato'] %}
                    <tr class="proposal-row" data-scambio-id="{{ scambio.id }}">
                        <td>{{ (scambio.data_risposta or scambio.data_proposta).strftime('%d/%m/%Y') }}</td>
                        <td>{% if scambio.squadra_proponente == nome_squadra %}{{ scambio.squadra_destinataria }}{% else %}{{ scambio.squadra_proponente }}{% endif %}</td>
                        <td>
                            <span class="badge 
                                {% if scambio.stato == 'accettato' %}bg-success
                                {% elif scambio.stato == 'rifiutato' %}bg-danger
                                {% else %}bg-secondary{% endif %}">
                                {{ scambio.stato|capitalize }}
                            </span>
                        </td>
                        <td class="text-center"><button type="button" class="btn btn-xs btn-outline-secondary view-proposal-btn">Vedi</button></td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4" class="text-center text-muted">Nessuno scambio nello storico</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Elemento nascosto con i dati degli scambi in JSON -->
<script type="application/json" id="scambi-json-data">
{{ scambi|tojson }}
</script>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Leggi i dati JSON dall'elemento nascosto
    const scambiDataElement = document.getElementById('scambi-json-data');
    if (!scambiDataElement) {
        console.error('Elemento scambi-json-data non trovato.');
        return;
    }
    
    let scambi_data = [];
    try {
        scambi_data = JSON.parse(scambiDataElement.textContent);
    } catch (e) {
        console.error('Errore nel parsing dei dati JSON degli scambi:', e);
        return;
    }
    
    const nomeSquadra = "{{ nome_squadra }}";
    const buttons = document.querySelectorAll('.view-proposal-btn');

    buttons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const proposalRow = this.closest('.proposal-row');
            const scambioId = proposalRow.dataset.scambioId;
            const table = proposalRow.closest('table');
            const actionUrl = table.dataset.actionUrl;

            // Controlla se la riga cliccata √® gi√† aperta
            const isAlreadyOpen = proposalRow.nextElementSibling?.classList.contains('details-row');

            // Chiudi tutte le altre righe aperte nella stessa tabella
            table.querySelectorAll('.details-row').forEach(row => {
                row.remove();
            });

            // Se era gi√† aperta, ci fermiamo qui (effetto toggle)
            if (isAlreadyOpen) {
                return;
            }
            
            const scambio = scambi_data.find(s => s.id == scambioId);
            if (!scambio) {
                alert("Errore: dati dello scambio non trovati.");
                return;
            }

            const detailsHtml = generateDetailsHtml(scambio, nomeSquadra, actionUrl);
            const detailsRow = document.createElement('tr');
            detailsRow.className = 'details-row';
            const cell = document.createElement('td');
            cell.colSpan = proposalRow.cells.length;
            cell.innerHTML = detailsHtml;
            detailsRow.appendChild(cell);

            proposalRow.parentNode.insertBefore(detailsRow, proposalRow.nextSibling);
        });
    });

    function generateDetailsHtml(scambio, currentUserTeam, actionUrl) {
        const isProposer = scambio.squadra_proponente === currentUserTeam;
        const isReceiver = scambio.squadra_destinataria === currentUserTeam;

        // --- Funzione helper per creare il contenuto di una sezione (offerta o richiesta) ---
        function buildTradeContent(players, credits, loanPlayers) {
            let items = [];
            if (players) {
                items.push(`<strong>Giocatori:</strong> ${players}`);
            }
            if (credits) {
                items.push(`<strong>Crediti:</strong> ${credits}`);
            }
            if (loanPlayers && loanPlayers.trim()) {
                items.push(`<strong>Prestiti:</strong><br>${loanPlayers.replace(/\n/g, '<br>')}`);
            }
            return items.length > 0 ? items.join('<br>') : '<span class="text-muted">Nessun elemento</span>';
        }

        const offerta = buildTradeContent(scambio.giocatori_offerti_nomi, scambio.crediti_offerti, scambio.prestiti_offerti_formattati);
        const richiesta = buildTradeContent(scambio.giocatori_richiesti_nomi, scambio.crediti_richiesti, scambio.prestiti_richiesti_formattati);
        
        // Determina quali bottoni mostrare
        let buttonsHtml = '';
        if (scambio.stato === 'in_attesa') {
            if (isProposer) {
                buttonsHtml = `
                    <form method="POST" action="${actionUrl}" onsubmit="return confirm('Sei sicuro di voler annullare questo scambio?');">
                        <input type="hidden" name="annulla_scambio" value="${scambio.id}">
                        <button type="submit" class="btn btn-warning btn-sm">
                            <i class="bi bi-x-circle"></i> Annulla Proposta
                        </button>
                    </form>`;
            } else if (isReceiver) {
                const isDisabled = scambio.valido === false;
                buttonsHtml = `
                    <form method="POST" action="${actionUrl}" onsubmit="return confirm('Sei sicuro di voler accettare questo scambio?');">
                        <input type="hidden" name="accetta_scambio" value="${scambio.id}">
                        <button type="submit" class="btn btn-success btn-sm" ${isDisabled ? 'disabled' : ''}>
                            <i class="bi bi-check-circle"></i> Accetta
                        </button>
                    </form>
                    <form method="POST" action="${actionUrl}" onsubmit="return confirm('Sei sicuro di voler rifiutare questo scambio?');">
                        <input type="hidden" name="rifiuta_scambio" value="${scambio.id}">
                        <button type="submit" class="btn btn-danger btn-sm">
                            <i class="bi bi-x-circle"></i> Rifiuta
                        </button>
                    </form>
                    ${isDisabled ? `<div class="alert-invalid mt-2"><i class="bi bi-exclamation-triangle-fill"></i> Proposta non valida per crediti/slot insufficienti</div>` : ''}`;
            }
        }

        // Template HTML finale
        return `
            <div class="trade-details-container">
                <div class="trade-grid">
                    <!-- Sezione Offerta -->
                    <div class="trade-side offer">
                        <div class="trade-side-title">
                            <i class="bi bi-arrow-up-circle-fill icon"></i>
                            <span>Offerta da ${scambio.squadra_proponente}</span>
                        </div>
                        <div class="trade-content">
                            ${offerta}
                        </div>
                    </div>
                    <!-- Sezione Richiesta -->
                    <div class="trade-side request">
                        <div class="trade-side-title">
                             <i class="bi bi-arrow-down-circle-fill icon"></i>
                            <span>Richiesta a ${scambio.squadra_destinataria}</span>
                        </div>
                        <div class="trade-content">
                            ${richiesta}
                        </div>
                    </div>
                </div>
                ${buttonsHtml ? `<div class="trade-actions">${buttonsHtml}</div>` : ''}
            </div>
        `;
    }
});
</script>
{% endblock %}