{% extends 'base.html' %}

{% block content %}
<style>
    .details-row {
        background-color: #f8f9fa;
        border-top: 2px solid #dee2e6;
        transition: all 0.3s ease;
    }

    .details-content {
        padding: 1.5rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    }

    .details-content .row > div {
        margin-bottom: 1.5rem;
    }

    .details-content h5 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .details-content h5::before {
        content: '';
        display: inline-block;
        width: 4px;
        height: 20px;
        background: linear-gradient(180deg, #0d6efd, #0d6efd);
        border-radius: 2px;
    }

    .details-content p {
        line-height: 1.6;
        color: #212529;
        font-size: 0.95rem;
    }

    .details-content .text-muted {
        font-style: italic;
        color: #6c757d;
    }

    .details-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid #dee2e6;
    }

    .details-buttons form {
        margin: 0;
    }

    .details-buttons .btn {
        font-weight: 500;
        padding: 0.5rem 1.5rem;
        transition: all 0.2s ease;
    }

    .details-buttons .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .alert-invalid {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        border-radius: 0.375rem;
        padding: 0.75rem 1.25rem;
        font-size: 0.9rem;
    }
</style>

<div class="container mt-5">

    <!-- Elemento nascosto per contenere i dati JSON in modo sicuro -->
    <div id="scambi-json-data" style="display: none;">{{ scambi|tojson }}</div>

    <!-- HEADER CON TITOLO -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <div>
            <h1 class="mb-0">Mercato - {{ nome_squadra }}</h1>
            <small class="text-muted">
                Crediti totali: <strong>{{ crediti }}</strong> |
                Crediti disponibili:
                <strong
                    {% if offerta_massima_possibile <= 0 %}
                        class="text-danger"
                    {% elif offerta_massima_possibile < 10 %}
                        class="text-warning"
                    {% else %}
                        class="text-success"
                    {% endif %}
                >
                    {{ offerta_massima_possibile }}
                </strong>
            </small>
        </div>
        <a href="{{ url_for('mercato.nuovo_scambio', nome_squadra=nome_squadra) }}"
           class="btn btn-primary btn-lg mt-2 mt-sm-0">
            Nuova proposta di scambio
        </a>
    </div>

    <!-- SEZIONE: SCAMBI PROPOSTI DA ME -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">Scambi proposti da me</div>
        <div class="card-body table-responsive bg-light">
            <table class="table table-striped table-hover align-middle" data-action-url="{{ url_for('mercato.user_mercato', nome_squadra=nome_squadra) }}">
                <thead class="table-light">
                    <tr>
                        <th>Data</th>
                        <th>Squadra destinataria</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for scambio in scambi if scambio.squadra_proponente == nome_squadra and scambio.stato == 'in_attesa' %}
                    <tr class="proposal-row" data-scambio-id="{{ scambio.id }}">
                        <td>{{ scambio.data_proposta.strftime('%d/%m/%Y') }}</td>
                        <td>{{ scambio.squadra_destinataria }}</td>
                        <td class="text-center"><button type="button" class="btn btn-sm btn-info view-proposal-btn">Vedi</button></td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" class="text-center text-muted">Nessuna proposta di scambio attiva</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- SEZIONE: SCAMBI RICEVUTI -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-warning text-dark">Scambi ricevuti</div>
        <div class="card-body table-responsive bg-light">
            <table class="table table-striped table-hover align-middle" data-action-url="{{ url_for('mercato.user_mercato', nome_squadra=nome_squadra) }}">
                <thead class="table-light">
                    <tr>
                        <th>Data</th>
                        <th>Proponente</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for scambio in scambi if scambio.squadra_destinataria == nome_squadra and scambio.stato == 'in_attesa' %}
                     <tr class="proposal-row" data-scambio-id="{{ scambio.id }}">
                        <td>{{ scambio.data_proposta.strftime('%d/%m/%Y') }}</td>
                        <td>{{ scambio.squadra_proponente }}</td>
                        <td class="text-center"><button type="button" class="btn btn-sm btn-info view-proposal-btn">Vedi</button></td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" class="text-center text-muted">Nessuno scambio ricevuto</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- SEZIONE: STORICO SCAMBI -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-secondary text-white">Storico Scambi</div>
        <div class="card-body table-responsive">
            <table class="table table-striped table-hover align-middle" data-action-url="{{ url_for('mercato.user_mercato', nome_squadra=nome_squadra) }}">
                <thead class="table-light">
                    <tr>
                        <th>Data</th>
                        <th>Controparte</th>
                        <th>Stato</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for scambio in scambi if scambio.stato in ['accettato', 'rifiutato', 'annullato'] %}
                    <tr class="proposal-row" data-scambio-id="{{ scambio.id }}">
                        <td>{{ (scambio.data_risposta or scambio.data_proposta).strftime('%d/%m/%Y') }}</td>
                        <td>{% if scambio.squadra_proponente == nome_squadra %}{{ scambio.squadra_destinataria }}{% else %}{{ scambio.squadra_proponente }}{% endif %}</td>
                        <td>
                            <span class="badge 
                                {% if scambio.stato == 'accettato' %}bg-success
                                {% elif scambio.stato == 'rifiutato' %}bg-danger
                                {% else %}bg-secondary{% endif %}">
                                {{ scambio.stato|capitalize }}
                            </span>
                        </td>
                        <td class="text-center"><button type="button" class="btn btn-sm btn-secondary view-proposal-btn">Vedi</button></td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4" class="text-center text-muted">Nessuno scambio nello storico</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded fired');
    
    // Read the JSON data from the hidden div
    const scambiDataElement = document.getElementById('scambi-json-data');
    if (!scambiDataElement) {
        console.error('scambi-json-data element not found');
        return;
    }
    
    let scambi_data = [];
    try {
        scambi_data = JSON.parse(scambiDataElement.textContent);
        console.log('Scambi data loaded:', scambi_data);
        if (scambi_data.length > 0) {
            console.log('First scambio structure:', scambi_data[0]);
            console.log('First scambio ID:', scambi_data[0].id);
        }
    } catch (e) {
        console.error('Error parsing scambi data:', e);
        console.error('Raw content:', scambiDataElement.textContent);
        return;
    }
    
    const nomeSquadra = "{{ nome_squadra }}";
    console.log('Nome squadra:', nomeSquadra);
    
    const buttons = document.querySelectorAll('.view-proposal-btn');
    console.log('Found', buttons.length, 'buttons');

    buttons.forEach((button, index) => {
        console.log('Attaching click handler to button', index);
        button.addEventListener('click', function(event) {
            console.log('Button clicked:', event);
            event.preventDefault();
            event.stopPropagation();
            
            const proposalRow = this.closest('.proposal-row');
            if (!proposalRow) {
                console.error('Could not find proposal row');
                return;
            }
            
            const scambioId = proposalRow.dataset.scambioId;
            console.log('Scambio ID:', scambioId);
            
            const table = proposalRow.closest('table');
            if (!table) {
                console.error('Could not find table');
                return;
            }
            
            const actionUrl = table.dataset.actionUrl;
            console.log('Action URL:', actionUrl);

            // Check if this row is already open
            let clickedRowIsAlreadyOpen = false;
            const existingDetailsRow = proposalRow.nextElementSibling;
            if (existingDetailsRow && existingDetailsRow.classList.contains('details-row')) {
                clickedRowIsAlreadyOpen = true;
                console.log('Row is already open');
            }

            // Close any open rows in this table
            table.querySelectorAll('.details-row').forEach(row => {
                row.remove();
            });

            if (clickedRowIsAlreadyOpen) {
                console.log('Closing row and exiting');
                return;
            }
            
            const scambio = scambi_data.find(s => s.id == scambioId);
            console.log('Found scambio:', scambio);

            if (!scambio) {
                console.error(`Scambio with ID ${scambioId} not found in scambi_data.`);
                alert("Errore: dati dello scambio non trovati.");
                return;
            }

            const detailsHtml = generateDetailsHtml(scambio, nomeSquadra, actionUrl);
            console.log('Generated details HTML');

            const detailsRow = document.createElement('tr');
            detailsRow.className = 'details-row';
            const cell = document.createElement('td');
            cell.colSpan = proposalRow.cells.length;
            cell.innerHTML = detailsHtml;
            detailsRow.appendChild(cell);

            proposalRow.parentNode.insertBefore(detailsRow, proposalRow.nextSibling);
            console.log('Details row inserted');
        });
    });

    function generateDetailsHtml(scambio, currentUserTeam, actionUrl) {
        const isProposer = scambio.squadra_proponente === currentUserTeam;
        const isReceiver = scambio.squadra_destinataria === currentUserTeam;

        let offeredItems = [];
        if (scambio.giocatori_offerti_nomi) offeredItems.push(`<strong>Giocatori:</strong> ${scambio.giocatori_offerti_nomi}`);
        if (scambio.crediti_offerti) offeredItems.push(`<strong>Crediti:</strong> ${scambio.crediti_offerti}`);
        const offerta = offeredItems.length > 0 ? offeredItems.join('<br>') : '<span class="text-muted">Niente</span>';

        let requestedItems = [];
        if (scambio.giocatori_richiesti_nomi) requestedItems.push(`<strong>Giocatori:</strong> ${scambio.giocatori_richiesti_nomi}`);
        if (scambio.crediti_richiesti) requestedItems.push(`<strong>Crediti:</strong> ${scambio.crediti_richiesti}`);
        const richiesta = requestedItems.length > 0 ? requestedItems.join('<br>') : '<span class="text-muted">Niente</span>';
        
        let buttonsHtml = '';
        if (scambio.stato === 'in_attesa') {
            if (isProposer) {
                buttonsHtml = `
                    <form method="POST" action="${actionUrl}" onsubmit="return confirm('Annullare questo scambio?');">
                        <input type="hidden" name="annulla_scambio" value="${scambio.id}">
                        <button type="submit" class="btn btn-warning btn-sm">
                            <i class="bi bi-x-circle"></i> Annulla Proposta
                        </button>
                    </form>`;
            } else if (isReceiver) {
                let disabledAttribute = '';
                // Safely check if the 'valido' property exists and is false
                if (scambio.hasOwnProperty('valido') && scambio.valido === false) {
                    disabledAttribute = 'disabled';
                }

                buttonsHtml = `
                    <form method="POST" action="${actionUrl}" onsubmit="return confirm('Accettare questo scambio?');">
                        <input type="hidden" name="accetta_scambio" value="${scambio.id}">
                        <button type="submit" class="btn btn-success btn-sm" ${disabledAttribute}>
                            <i class="bi bi-check-circle"></i> Accetta
                        </button>
                    </form>
                    <form method="POST" action="${actionUrl}" onsubmit="return confirm('Rifiutare questo scambio?');">
                        <input type="hidden" name="rifiuta_scambio" value="${scambio.id}">
                        <button type="submit" class="btn btn-danger btn-sm">
                            <i class="bi bi-x-circle"></i> Rifiuta
                        </button>
                    </form>
                    ${disabledAttribute ? `<div class="alert-invalid mt-2"><i class="bi bi-exclamation-triangle"></i> Proposta non valida</div>` : ''}`;
            }
        }

        return `
            <div class="details-content">
                <div class="row">
                    <div class="col-md-6">
                        <h5>ðŸ“¤ Offerta di ${scambio.squadra_proponente}</h5>
                        <p class="mb-0">${offerta}</p>
                    </div>
                    <div class="col-md-6">
                        <h5>ðŸ“¥ Richiesta a ${scambio.squadra_destinataria}</h5>
                        <p class="mb-0">${richiesta}</p>
                    </div>
                </div>
                ${buttonsHtml ? `<div class="details-buttons">${buttonsHtml}</div>` : ''}
            </div>
        `;
    }
});
</script>
{% endblock %}