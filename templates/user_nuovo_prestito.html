{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">

    <!-- HEADER -->
    <div class="text-center mb-4">
        <h1 class="mb-3">Nuovo Prestito - {{ nome_squadra }}</h1>
        <p class="text-muted">
            Crediti totali: <strong>{{ crediti }}</strong> |
            Crediti disponibili:
            <strong 
                {% if crediti_disponibili <= 0 %}
                    class="text-danger"
                {% elif crediti_disponibili < 10 %}
                    class="text-warning"
                {% else %}
                    class="text-success"
                {% endif %}
            >
                {{ crediti_disponibili }}
            </strong>
        </p>
    </div>

    <!-- FORM PRESTITO -->
    <div class="card shadow-sm mx-auto" style="max-width: 700px;">
        <div class="card-body">

            <form method="POST" action="{{ url_for('prestiti.nuovo_prestito', nome_squadra=nome_squadra) }}">
                
                <!-- Squadra da cui richiedere il prestito -->
                <div class="mb-3">
                    <label for="squadra_prestante" class="form-label fw-semibold">Squadra da cui richiedere il prestito</label>
                    <select id="squadra_prestante" name="squadra_prestante" class="form-select" required>
                        <option value="" disabled selected>Seleziona squadra</option>
                        {% for s in squadre %}
                            <option value="{{ s.nome }}">{{ s.nome }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Giocatore da richiedere -->
                <div class="mb-3">
                    <label for="giocatore_richiesto" class="form-label fw-semibold">Giocatore richiesto</label>
                    <select id="giocatore_richiesto" name="giocatore_richiesto" class="form-select"required>
                        <option value="">Seleziona prima una squadra</option>
                    </select>
                </div>

                <!-- Data di scadenza -->
                <div class="mb-3">
                    <label for="data_fine" class="form-label fw-semibold">Data di scadenza del prestito</label>
                    <input 
                        type="date" 
                        id="data_fine" 
                        name="data_fine" 
                        class="form-control" 
                        required
                        min="{{ current_date }}"
                    >
                    <div class="form-text text-muted">
                        Per facilitare il riscatto consigliamo di impostare la data di scadenza al 2 luglio, quando gli slot dei giocatori retrocessi vi si saranno liberati.<br>
                    </div>
                </div>

                <!-- Tipo prestito -->
                <div class="mb-3">
                    <label for="tipo_prestito" class="form-label fw-semibold">Tipo di prestito</label>
                    <select id="tipo_prestito" name="tipo_prestito" class="form-select">
                        <option value="">Seleziona tipo</option>
                        <option value="Secco">Secco</option>
                        <option value="Con diritto di riscatto">Con diritto di riscatto</option>
                        <option value="Con obbligo di riscatto">Con obbligo di riscatto</option>
                    </select>
                </div>

                <!-- Costo prestito -->
                <div class="mb-3">
                    <label for="costo_prestito" class="form-label fw-semibold">Costo del prestito (crediti)</label>
                    <input 
                        type="number" 
                        id="costo_prestito" 
                        name="costo_prestito" 
                        class="form-control" 
                        min="0"
                        value="0"
                        placeholder="0"
                    >
                    <div class="form-text">Crediti da versare alla squadra prestante.</div>
                </div>

                <!-- Crediti riscatto -->
                <div class="mb-3">
                    <label for="crediti_riscatto" class="form-label fw-semibold">Crediti per il riscatto</label>
                    <input 
                        type="number" 
                        id="crediti_riscatto" 
                        name="crediti_riscatto" 
                        class="form-control" 
                        min="0"
                        value="0"
                        placeholder="0"
                    >
                    <div class="form-text">Crediti per l'eventuale riscatto del giocatore (solo se previsto).</div>
                </div>

                <!-- Note opzionali -->
                <div class="mb-3">
                    <label for="note" class="form-label">Note (opzionali)</label>
                    <textarea name="note" id="note" class="form-control" rows="3" placeholder="Aggiungi eventuali note al prestito..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary w-100 py-2">Invia richiesta di prestito</button>
            </form>

        </div>
    </div>

</div>

<!-- Tom Select CSS -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">

<!-- Tom Select JS -->
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const selectSquadra = new TomSelect("#squadra_prestante", {
        placeholder: "Seleziona squadra...",
        create: false,
        plugins: ['dropdown_input']
    });

    const selectGiocatore = new TomSelect("#giocatore_richiesto", {
        placeholder: "Seleziona giocatore...",
        create: false,
        plugins: ['dropdown_input']
    });

    selectGiocatore.clearOptions();

    const allGiocatori = JSON.parse('{{ giocatori|tojson|safe }}'); 
    // giocatori: lista completa [{id, nome, squadra_att}, ...]

    // Gestione campo crediti_riscatto in base al tipo di prestito
    const tipoPrestito = document.getElementById('tipo_prestito');
    const creditiRiscatto = document.getElementById('crediti_riscatto');

    tipoPrestito.addEventListener('change', function() {
        if (this.value === 'Secco') {
            creditiRiscatto.value = '0';
            creditiRiscatto.disabled = true;
            creditiRiscatto.style.backgroundColor = '#e9ecef';
        } else {
            creditiRiscatto.disabled = false;
            creditiRiscatto.style.backgroundColor = '';
        }
    });

    // Imposta lo stato iniziale se già selezionato
    if (tipoPrestito.value === 'Secco') {
        creditiRiscatto.value = '0';
        creditiRiscatto.disabled = true;
        creditiRiscatto.style.backgroundColor = '#e9ecef';
    }

    selectSquadra.on('change', (squadraSelezionata) => {
        selectGiocatore.clearOptions();

        if (!squadraSelezionata) {
            selectGiocatore.disable();
            return;
        }

        // Filtra i giocatori della squadra selezionata
        const filtrati = allGiocatori.filter(g => g.squadra_att === squadraSelezionata);
        filtrati.forEach(g => selectGiocatore.addOption({ value: g.id, text: g.nome }));

        selectGiocatore.enable();
        selectGiocatore.refreshOptions(false);
    });

    // Funzione per formattare una data in YYYY-MM-DD
    function formatDateToString(date) {
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    // Imposta la data minima (domani) per il campo data_fine
    const oggi = new Date();
    const domani = new Date(oggi);
    domani.setDate(domani.getDate() + 1); // aggiunge 1 giorno
    const domaniStr = formatDateToString(domani);
    document.getElementById('data_fine').setAttribute('min', domaniStr);

    // Imposta il valore di default: il primo 2 giugno disponibile
    const annoCorrente = oggi.getFullYear();
    const giunoDiQuestAnno = new Date(annoCorrente, 6, 2); // mese 6 = luglio (0-indexed)
    
    let defaultDate;
    if (oggi <= giunoDiQuestAnno) {
        // Se oggi è prima o uguale al 2 giugno di quest'anno, usa giugno di quest'anno
        defaultDate = formatDateToString(giunoDiQuestAnno);
    } else {
        // Altrimenti usa giugno dell'anno prossimo
        defaultDate = formatDateToString(new Date(annoCorrente + 1, 6, 2));
    }
    document.getElementById('data_fine').value = defaultDate;
});
</script>

{% endblock %}
