{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="text-center mb-4">
        <h1>Inserimento nuova asta</h1>
        <p class="lead">Cerca un giocatore per iniziare una nuova asta.</p>
    </div>

    <!-- Form di ricerca giocatore -->
    <form id="nuovaAstaForm" method="POST">
        <div class="mb-4 position-relative">
            <label for="giocatore" class="form-label">Cerca Giocatore</label>
            <input type="text" id="giocatore" name="giocatore" class="form-control" placeholder="Inizia a digitare il nome..." autocomplete="off">
            <div id="suggerimenti" class="list-group position-absolute w-100" style="z-index:1000;"></div>

            <!-- Messaggi dinamici -->
            <div id="erroreGiocatore" class="text-danger mt-2" style="display:none;">Seleziona un giocatore valido dalla lista.</div>
            <div id="confermaGiocatore" class="text-success mt-2" style="display:none;">Giocatore selezionato correttamente!</div>
            
            {% if enable_player_creation %}
            <div id="creaGiocatore" class="mt-2" style="display:none;">
                <span class="text-muted" style="font-size: 0.9rem;"><i class="fas fa-info-circle"></i> Giocatore non trovato.</span> 
                <button type="button" class="btn btn-success btn-sm" id="btnApriModal" style="padding: 0.25rem 0.5rem; font-size: 0.9rem;">
                    <i class="fas fa-plus"></i> Crea Giocatore
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Bottone di conferma -->
        <div class="text-center">
            <button type="submit" class="btn btn-success btn-lg" id="btnAvviaAsta" disabled>Avvia Asta</button>
        </div>
    </form>
</div>

{% if enable_player_creation %}
<!-- Overlay personalizzato per creazione giocatore -->
<div id="overlayCreazione" class="custom-overlay" style="display:none;">
    <div id="popupCreazione" class="custom-popup">
        <div class="custom-popup-header">
            <h5>Crea Nuovo Giocatore</h5>
            <button type="button" class="custom-popup-close" id="btnChiudiPopup">&times;</button>
        </div>
        <form id="formCreaGiocatore" method="POST" action="">
            <div class="custom-popup-body">
                <input type="hidden" name="crea_nuovo" value="1">
                
                <div class="mb-3">
                    <label for="nome_nuovo" class="form-label">Nome Giocatore <span class="text-danger">*</span></label>
                    <input type="text" id="nome_nuovo" name="nome_nuovo" class="form-control" required>
                </div>
                
                <div class="mb-3">
                    <label for="club_nuovo" class="form-label">Squadra di Appartenenza <span class="text-danger">*</span></label>
                    <input type="text" id="club_nuovo" name="club_nuovo" class="form-control" placeholder="Es: Juventus" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Quotazione</label>
                    <div class="form-control custom-readonly-field">
                        666
                    </div>
                    <small class="text-muted">Quotazione di default</small>
                </div>
            </div>
            <div class="custom-popup-footer">
                <button type="button" class="btn btn-secondary" id="btnAnnulla">Annulla</button>
                <button type="submit" class="btn btn-success">Crea e Avvia Asta</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<script>
// Usa window.onload per assicurarsi che Bootstrap sia caricato
window.addEventListener("load", function() {
    const input = document.getElementById("giocatore");
    const suggerimenti = document.getElementById("suggerimenti");
    const form = document.getElementById("nuovaAstaForm");
    const erroreMsg = document.getElementById("erroreGiocatore");
    const confermaMsg = document.getElementById("confermaGiocatore");
    const creaMsg = document.getElementById("creaGiocatore");
    const btnAvviaAsta = document.getElementById("btnAvviaAsta");

    // Lista di giocatori passata dal server
    const giocatori = JSON.parse('{{ giocatori_disponibili_per_asta|tojson|safe }}');
    // @ts-ignore
    const enableCreation = '{{ enable_player_creation|tojson|safe }}' === 'true' || '{{ enable_player_creation|tojson|safe }}' === 'True';

    let giocatoreTrovato = false;
    let nomeRicercato = "";

    input.addEventListener("input", function() {
        const query = this.value.toLowerCase().trim();
        nomeRicercato = this.value.trim();
        
        suggerimenti.innerHTML = "";
        erroreMsg.style.display = "none";
        confermaMsg.style.display = "none";
        if (creaMsg) creaMsg.style.display = "none";
        
        giocatoreTrovato = false;
        btnAvviaAsta.disabled = true;

        if (query.length < 2) return;

        const filtrati = giocatori.filter(g => g.toLowerCase().includes(query));

        if (filtrati.length > 0) {
            // Mostra suggerimenti se trovati
            filtrati.forEach(g => {
                const button = document.createElement("button");
                button.type = "button";
                button.classList.add("list-group-item", "list-group-item-action");
                button.textContent = g;
                button.onclick = () => {
                    input.value = g;
                    nomeRicercato = g;
                    suggerimenti.innerHTML = "";
                    erroreMsg.style.display = "none";
                    if (creaMsg) creaMsg.style.display = "none";
                    confermaMsg.style.display = "block";
                    giocatoreTrovato = true;
                    btnAvviaAsta.disabled = false;
                };
                suggerimenti.appendChild(button);
            });
        } else {
            // Nessun giocatore trovato - mostra opzione creazione se abilitata
            if (enableCreation && query.length >= 2) {
                if (creaMsg) creaMsg.style.display = "block";
            }
        }
    });

    // Chiudi suggerimenti cliccando fuori
    document.addEventListener("click", function(e) {
        if (!input.contains(e.target) && !suggerimenti.contains(e.target)) {
            suggerimenti.innerHTML = "";
        }
    });

    // Controllo submit form principale
    form.addEventListener("submit", function(e) {
        const valore = input.value.trim();
        if (!giocatori.includes(valore)) {
            e.preventDefault();
            confermaMsg.style.display = "none";
            erroreMsg.style.display = "block";
        } else {
            if (!confirm(`Vuoi davvero avviare un'asta per ${valore}?`)) {
                e.preventDefault();
            }
        }
    });

    // Gestione form creazione giocatore
    const formCrea = document.getElementById("formCreaGiocatore");
    if (formCrea) {
        formCrea.addEventListener("submit", function(e) {
            const nome = document.getElementById("nome_nuovo").value.trim();
            const club = document.getElementById("club_nuovo").value.trim();
            
            if (!nome) {
                e.preventDefault();
                alert("Il nome del giocatore è obbligatorio.");
                return;
            }
            
            if (!club) {
                e.preventDefault();
                alert("La squadra di appartenenza è obbligatoria.");
                return;
            }
            
            if (!confirm(`Vuoi davvero creare il giocatore "${nome}" (${club}) e avviare l'asta?`)) {
                e.preventDefault();
            }
        });
    }
    
    // Gestione apertura/chiusura overlay personalizzato
    const btnApriModal = document.getElementById('btnApriModal');
    const overlayCreazione = document.getElementById('overlayCreazione');
    const btnChiudiPopup = document.getElementById('btnChiudiPopup');
    const btnAnnulla = document.getElementById('btnAnnulla');
    
    if (btnApriModal && overlayCreazione) {
        // Apri overlay
        btnApriModal.addEventListener('click', function(e) {
            e.preventDefault();
            // Precompila il nome
            const nomeNuovo = document.getElementById("nome_nuovo");
            if (nomeNuovo && input) {
                nomeNuovo.value = input.value.trim();
            }
            overlayCreazione.style.display = 'flex';
        });
        
        // Chiudi overlay con X
        if (btnChiudiPopup) {
            btnChiudiPopup.addEventListener('click', function() {
                overlayCreazione.style.display = 'none';
            });
        }
        
        // Chiudi overlay con bottone Annulla
        if (btnAnnulla) {
            btnAnnulla.addEventListener('click', function() {
                overlayCreazione.style.display = 'none';
            });
        }
        
        // Chiudi overlay cliccando fuori dal popup
        overlayCreazione.addEventListener('click', function(e) {
            if (e.target === overlayCreazione) {
                overlayCreazione.style.display = 'none';
            }
        });
    }
});
</script>

{% endblock %}
