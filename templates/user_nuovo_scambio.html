{% extends 'base.html' %}

{% block content %}
<div class="container-fluid py-4 negotiation-page">

    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
        <div>
            <h1 class="mb-1">üíº Nuova Trattativa di Mercato</h1>
            <p class="mb-0 text-muted">Crea una proposta di scambio | <strong>{{ nome_squadra }}</strong></p>
        </div>
        <a href="{{ url_for('mercato.user_mercato', nome_squadra=nome_squadra) }}" class="btn btn-outline-light btn-lg">‚Üê Indietro</a>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step-item">
            <span class="step-number active">1</span>
            <span>Controparte</span>
        </div>
        <span class="step-arrow">‚Üí</span>
        <div class="step-item">
            <span class="step-number">2</span>
            <span>Scambio</span>
        </div>
        <span class="step-arrow">‚Üí</span>
        <div class="step-item">
            <span class="step-number">3</span>
            <span>Prestiti (opzionale)</span>
        </div>
        <span class="step-arrow">‚Üí</span>
        <div class="step-item">
            <span class="step-number">4</span>
            <span>Invia</span>
        </div>
    </div>

    <div class="alert alert-info mb-4 info-box">
        <strong>üí° Suggerimento:</strong> Per facilitare il riscatto, imposta la data di scadenza dei prestiti al <strong>2 luglio</strong>, quando gli slot dei giocatori retrocessi e svincolati saranno liberati.
    </div>

    <form method="POST" action="{{ url_for('mercato.nuovo_scambio', nome_squadra=nome_squadra) }}"
          class="negotiation-form"
          data-slot-liberi-miei="{{ slot_liberi_miei }}"
          data-crediti-miei="{{ crediti_effettivi }}"
          data-slot-prestiti-miei="{{ slot_prestiti_miei }}">

        <!-- STEP 1: Seleziona Controparte -->
        <div class="card soft-card mb-4 section-card active" id="step-1">
            <div class="card-body">
                <h4 class="mb-3">üìã Step 1: Seleziona la squadra con cui trattare</h4>
                <div class="row g-3 align-items-end">
                    <div class="col-lg-8">
                        <label for="squadra_destinataria" class="form-label fw-semibold">Controparte</label>
                        <select id="squadra_destinataria" name="squadra_destinataria" class="form-select form-select-lg" required>
                            <option value="" selected disabled>-- Seleziona una squadra --</option>
                            {% for s in squadre %}
                                {% if s.nome != nome_squadra %}
                                    <option value="{{ s.nome }}"
                                            data-max-crediti="{{ s.offerta_massima_possibile }}"
                                            data-slot-liberi="{{ s.slot_liberi }}"
                                            data-slot-prestiti="{{ s.slot_prestiti }}">
                                        {{ s.nome }}
                                    </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <div class="help-text">Scegli la squadra con cui vuoi avviare una trattativa</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Riepilogo Slot & Crediti -->
        <div class="card soft-card mb-4">
            <div class="card-body">
                <h5 class="mb-3">üìä Riepilogo Risorse</h5>
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="p-3 bg-light rounded">
                            <h6 class="fw-bold mb-3 text-primary">{{ nome_squadra }}</h6>
                            <div class="slot-summary">
                                <div class="slot-summary-item">
                                    <div class="slot-summary-label">Slot Rosa</div>
                                    <div class="slot-summary-value" id="card-miei-slot-now">‚Äî</div>
                                    <div class="slot-summary-label">‚Üí <span id="card-miei-slot-after">‚Äî</span></div>
                                </div>
                                <div class="slot-summary-item">
                                    <div class="slot-summary-label">Slot Prestiti</div>
                                    <div class="slot-summary-value" id="card-miei-prestiti-now">‚Äî</div>
                                    <div class="slot-summary-label">‚Üí <span id="card-miei-prestiti-after">‚Äî</span></div>
                                </div>
                                <div class="slot-summary-item">
                                    <div class="slot-summary-label">Crediti</div>
                                    <div class="slot-summary-value" id="card-miei-crediti-now">‚Äî</div>
                                    <div class="slot-summary-label">‚Üí <span id="card-miei-crediti-after">‚Äî</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="p-3 bg-light rounded">
                            <h6 class="fw-bold mb-3 text-success"><span id="card-dest-team">Controparte</span></h6>
                            <div class="slot-summary">
                                <div class="slot-summary-item">
                                    <div class="slot-summary-label">Slot Rosa</div>
                                    <div class="slot-summary-value" id="card-dest-slot-now">‚Äî</div>
                                    <div class="slot-summary-label">‚Üí <span id="card-dest-slot-after">‚Äî</span></div>
                                </div>
                                <div class="slot-summary-item">
                                    <div class="slot-summary-label">Slot Prestiti</div>
                                    <div class="slot-summary-value" id="card-dest-prestiti-now">‚Äî</div>
                                    <div class="slot-summary-label">‚Üí <span id="card-dest-prestiti-after">‚Äî</span></div>
                                </div>
                                <div class="slot-summary-item">
                                    <div class="slot-summary-label">Crediti</div>
                                    <div class="slot-summary-value" id="card-dest-crediti-now">‚Äî</div>
                                    <div class="slot-summary-label">‚Üí <span id="card-dest-crediti-after">‚Äî</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 2: Scambio Giocatori e Crediti -->
        <div class="card soft-card mb-4 section-card" id="step-2">
            <div class="card-body">
                <h4 class="mb-4">‚öΩ Step 2: Definisci lo Scambio</h4>
                
                <div class="row g-4">
                    <!-- Cosa Offri -->
                    <div class="col-lg-6">
                        <div class="trade-side offer">
                            <span class="trade-side-label">üîµ COSA OFFRI</span>
                            
                            <div class="mb-4">
                                <label for="giocatori_offerti" class="form-label fw-semibold">
                                    üë• Giocatori 
                                    <span class="badge bg-primary">Max: <span id="max_offerti">{{ miei_giocatori|length }}</span></span>
                                </label>
                                <select multiple name="giocatori_offerti" id="giocatori_offerti" class="form-select" size="6">
                                    {% for g in miei_giocatori %}
                                        <option value="{{ g.id }}">{{ g.nome }}</option>
                                    {% endfor %}
                                </select>
                                <div class="help-text">Seleziona uno o pi√π giocatori dalla tua rosa</div>
                            </div>
                            
                            <div>
                                <label for="crediti_offerti" class="form-label fw-semibold">
                                    üí∞ Crediti 
                                    <span class="badge bg-primary">Disponibili: {{ crediti_effettivi }}</span>
                                </label>
                                <input type="number" min="0" name="crediti_offerti" id="crediti_offerti" 
                                       class="form-control form-control-lg" max="{{ crediti_effettivi }}" 
                                       placeholder="Inserisci importo">
                                <div class="help-text">Massimo {{ crediti_effettivi }} crediti</div>
                            </div>
                        </div>
                    </div>

                    <!-- Cosa Richiedi -->
                    <div class="col-lg-6">
                        <div class="trade-side">
                            <span class="trade-side-label">üü¢ COSA RICHIEDI</span>
                            
                            <div class="mb-4">
                                <label for="giocatori_richiesti" class="form-label fw-semibold">
                                    üë• Giocatori 
                                    <span class="badge bg-success">Max: <span id="max_richiesti">0</span></span>
                                </label>
                                <select multiple name="giocatori_richiesti" id="giocatori_richiesti" 
                                        class="form-select" size="6" disabled>
                                </select>
                                <div class="help-text">Prima seleziona una controparte</div>
                            </div>
                            
                            <div>
                                <label for="crediti_richiesti" class="form-label fw-semibold">
                                    üí∞ Crediti
                                    <span class="badge bg-success" id="crediti-richiesti-max-badge">Max: 0</span>
                                </label>
                                <input type="number" min="0" name="crediti_richiesti" id="crediti_richiesti" 
                                       class="form-control form-control-lg" disabled placeholder="Inserisci importo">
                                <div class="help-text">Prima seleziona una controparte</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card soft-card mb-4 section-card" id="step-3">
            <div class="card-body">
                <h4 class="mb-3">ü§ù Step 3: Aggiungi Prestiti (Opzionale)</h4>
                <!-- Prestito 1 -->
                <div class="card mb-3 loan-card" id="loan1">
                    <div class="card-header loan-toggle d-flex align-items-center gap-2 bg-success text-white" 
                        onclick="document.getElementById('enable_prestito1').click()">
                        <input type="checkbox" id="enable_prestito1" name="enable_prestito1" 
                               class="form-check-input m-0" onclick="event.stopPropagation()">
                        <label for="enable_prestito1" class="form-check-label fw-semibold mb-0">
                            ‚ûï Prestito #1
                        </label>
                    </div>
                    <div class="card-body loan-body d-none" id="loan1-body">
                        <div class="row g-4">
                            <div class="col-lg-6">
                                <div class="trade-side offer" id="trade-side-prestito1-offerto">
                                    <span class="trade-side-label">üîµ PRESTITO OFFERTO</span>
                                    <div class="mb-3">
                                        <label for="prestito1_offerto" class="form-label fw-semibold">Giocatore</label>
                                        <select id="prestito1_offerto" name="prestito1_offerto" class="form-select" disabled>
                                            <option value="">Seleziona giocatore</option>
                                            {% for g in miei_giocatori %}
                                                <option value="{{ g.id }}">{{ g.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="prestito1_tipo_offerto" class="form-label fw-semibold">Tipo Prestito</label>
                                        <select id="prestito1_tipo_offerto" name="prestito1_tipo_offerto" class="form-select" disabled>
                                            <option value="">-- Seleziona --</option>
                                            <option value="Secco">Secco</option>
                                            <option value="Diritto">Con diritto di riscatto</option>
                                            <option value="Obbligo">Con obbligo di riscatto</option>
                                        </select>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <label for="prestito1_data_fine_offerta" class="form-label fw-semibold">Data Fine</label>
                                            <input type="date" id="prestito1_data_fine_offerta" name="prestito1_data_fine_offerta" class="form-control">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="prestito1_riscatto_offerto" class="form-label fw-semibold">Riscatto</label>
                                            <input type="number" min="0" id="prestito1_riscatto_offerto" name="prestito1_riscatto_offerto" 
                                                   class="form-control" placeholder="0" disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="trade-side" id="trade-side-prestito1-richiesto">
                                    <span class="trade-side-label">üü¢ PRESTITO RICHIESTO</span>
                                    <div class="mb-3">
                                        <label for="prestito1_richiesto" class="form-label fw-semibold">Giocatore</label>
                                        <select id="prestito1_richiesto" name="prestito1_richiesto" class="form-select" disabled>
                                            <option value="">Seleziona giocatore</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="prestito1_tipo_richiesto" class="form-label fw-semibold">Tipo Prestito</label>
                                        <select id="prestito1_tipo_richiesto" name="prestito1_tipo_richiesto" class="form-select" disabled>
                                            <option value="">-- Seleziona --</option>
                                            <option value="Secco">Secco</option>
                                            <option value="Diritto">Con diritto di riscatto</option>
                                            <option value="Obbligo">Con obbligo di riscatto</option>
                                        </select>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <label for="prestito1_data_fine_richiesta" class="form-label fw-semibold">Data Fine</label>
                                            <input type="date" id="prestito1_data_fine_richiesta" name="prestito1_data_fine_richiesta" class="form-control">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="prestito1_riscatto_richiesto" class="form-label fw-semibold">Riscatto</label>
                                            <input type="number" min="0" id="prestito1_riscatto_richiesto" name="prestito1_riscatto_richiesto" 
                                                   class="form-control" placeholder="0" disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            <!-- Prestito 2 -->
            <div class="card mb-3 loan-card" id="loan2">
                    <div class="card-header loan-toggle d-flex align-items-center gap-2 bg-success text-white" 
                        onclick="document.getElementById('enable_prestito2').click()">
                        <input type="checkbox" id="enable_prestito2" name="enable_prestito2" 
                               class="form-check-input m-0" onclick="event.stopPropagation()">
                        <label for="enable_prestito2" class="form-check-label fw-semibold mb-0">
                            ‚ûï Prestito #2
                        </label>
                    </div>
                    <div class="card-body loan-body d-none" id="loan2-body">
                        <div class="row g-4">
                            <div class="col-lg-6">
                                <div class="trade-side offer" id="trade-side-prestito2-offerto">
                                    <span class="trade-side-label">üîµ PRESTITO OFFERTO</span>
                                    <div class="mb-3">
                                        <label for="prestito2_offerto" class="form-label fw-semibold">Giocatore</label>
                                        <select id="prestito2_offerto" name="prestito2_offerto" class="form-select" disabled>
                                            <option value="">Seleziona giocatore</option>
                                            {% for g in miei_giocatori %}
                                                <option value="{{ g.id }}">{{ g.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="prestito2_tipo_offerto" class="form-label fw-semibold">Tipo Prestito</label>
                                        <select id="prestito2_tipo_offerto" name="prestito2_tipo_offerto" class="form-select" disabled>
                                            <option value="">-- Seleziona --</option>
                                            <option value="Secco">Secco</option>
                                            <option value="Diritto">Con diritto di riscatto</option>
                                            <option value="Obbligo">Con obbligo di riscatto</option>
                                        </select>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <label for="prestito2_data_fine_offerta" class="form-label fw-semibold">Data Fine</label>
                                            <input type="date" id="prestito2_data_fine_offerta" name="prestito2_data_fine_offerta" class="form-control">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="prestito2_riscatto_offerto" class="form-label fw-semibold">Riscatto</label>
                                            <input type="number" min="0" id="prestito2_riscatto_offerto" name="prestito2_riscatto_offerto" 
                                                   class="form-control" placeholder="0" disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="trade-side" id="trade-side-prestito2-richiesto">
                                    <span class="trade-side-label">üü¢ PRESTITO RICHIESTO</span>
                                    <div class="mb-3">
                                        <label for="prestito2_richiesto" class="form-label fw-semibold">Giocatore</label>
                                        <select id="prestito2_richiesto" name="prestito2_richiesto" class="form-select" disabled>
                                            <option value="">Seleziona giocatore</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="prestito2_tipo_richiesto" class="form-label fw-semibold">Tipo Prestito</label>
                                        <select id="prestito2_tipo_richiesto" name="prestito2_tipo_richiesto" class="form-select" disabled>
                                            <option value="">-- Seleziona --</option>
                                            <option value="Secco">Secco</option>
                                            <option value="Diritto">Con diritto di riscatto</option>
                                            <option value="Obbligo">Con obbligo di riscatto</option>
                                        </select>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <label for="prestito2_data_fine_richiesta" class="form-label fw-semibold">Data Fine</label>
                                            <input type="date" id="prestito2_data_fine_richiesta" name="prestito2_data_fine_richiesta" class="form-control">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="prestito2_riscatto_richiesto" class="form-label fw-semibold">Riscatto</label>
                                            <input type="number" min="0" id="prestito2_riscatto_richiesto" name="prestito2_riscatto_richiesto" 
                                                   class="form-control" placeholder="0" disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="step-divider" role="separator" aria-hidden="true"></div>
        <!-- STEP 4: Messaggio e Invio -->
        <div class="card soft-card mb-4 section-card" id="step-4">
            <div class="card-body">
                <h4 class="mb-3">üí¨ Step 4: Messaggio e Invio</h4>
                <label for="messaggio" class="form-label fw-semibold">Messaggio opzionale</label>
                <textarea name="messaggio" id="messaggio" class="form-control" rows="4" 
                          placeholder="Aggiungi note, condizioni speciali o dettagli sulla trattativa..."></textarea>
                <div class="help-text mb-4">Usa questo spazio per spiegare meglio la tua proposta o aggiungere clausole particolari</div>
                
                <button type="submit" class="btn btn-success btn-lg w-100 py-3">
                    <strong>üì§ Invia Proposta di Scambio</strong>
                </button>
            </div>
        </div>
    </form>
</div>

<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // Funzione per formattare una data in YYYY-MM-DD
    function formatDateToString(date) {
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    const nome_squadra = "{{ nome_squadra }}";

    // Imposta il valore di default al prossimo 2 luglio per i campi data prestito
    const oggi = new Date();
    const annoCorrente = oggi.getFullYear();
    const luglioDiQuestAnno = new Date(annoCorrente, 6, 2); // mese 6 = luglio (0-indexed)
    
    let defaultDate;
    if (oggi <= luglioDiQuestAnno) {
        // Se oggi √® prima o uguale al 2 luglio di quest'anno, usa luglio di quest'anno
        defaultDate = formatDateToString(luglioDiQuestAnno);
    } else {
        // Altrimenti usa luglio dell'anno prossimo
        defaultDate = formatDateToString(new Date(annoCorrente + 1, 6, 2));
    }

    // Imposta il valore di default per i campi data prestito
    const dataInputs = [
        'prestito1_data_fine_richiesta',
        'prestito1_data_fine_offerta',
        'prestito2_data_fine_richiesta',
        'prestito2_data_fine_offerta'
    ];
    dataInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.value = defaultDate;
        }
    });

    const form = document.querySelector('.negotiation-form');
    const myFreeSlots = parseInt(form.dataset.slotLiberiMiei) || 0;
    const myCreditsAvailable = parseInt(form.dataset.creditiMiei) || 0;
    const mySlotPrestiti = parseInt(form.dataset.slotPrestitiMiei) || 0;

    // Snapshot elements
    const myOccupiedSpan = document.getElementById('card-miei-slot-now');
    const destOccupiedSpan = document.getElementById('card-dest-slot-now');
    const myOccupiedAfterSpan = document.getElementById('card-miei-slot-after');
    const destOccupiedAfterSpan = document.getElementById('card-dest-slot-after');
    
    const myPrestitiSpan = document.getElementById('card-miei-prestiti-now');
    const myPrestitiAfterSpan = document.getElementById('card-miei-prestiti-after');
    const destPrestitiSpan = document.getElementById('card-dest-prestiti-now');
    const destPrestitiAfterSpan = document.getElementById('card-dest-prestiti-after');
    
    const myCreditsSpan = document.getElementById('card-miei-crediti-now');
    const myCreditsAfterSpan = document.getElementById('card-miei-crediti-after');
    const destCreditsSpan = document.getElementById('card-dest-crediti-now');
    const destCreditsAfterSpan = document.getElementById('card-dest-crediti-after');

    // Mobile summary bar elements
    const mobileMieiSlotAfter = document.getElementById('mobile-miei-slot-after');
    const mobileMieiCredAfter = document.getElementById('mobile-miei-crediti-after');
    const mobileDestSlotAfter = document.getElementById('mobile-dest-slot-after');
    const mobileDestCredAfter = document.getElementById('mobile-dest-crediti-after');
    const mobileDestTeam = document.getElementById('mobile-dest-team');

    const creditiOffertiInput = document.getElementById('crediti_offerti');
    const creditiRichiestiInput = document.getElementById('crediti_richiesti');

    const maxOffertiSpan = document.getElementById('max_offerti');
    const maxRichiestiSpan = document.getElementById('max_richiesti');

    const selectSquadra = document.getElementById('squadra_destinataria');
    const destTeamLabel = document.getElementById('card-dest-team');

    const allOptions = JSON.parse('{{ giocatori|tojson|safe }}');
    const contractById = new Map(allOptions.map(g => [String(g.id), g.tipo_contratto]));

    // Scambio selects
    const selectOfferti = new TomSelect("#giocatori_offerti", {
        plugins: ['remove_button'],
        placeholder: "Giocatori da offrire",
        create: false,
        maxItems: 30
    });

    const selectRichiesti = new TomSelect("#giocatori_richiesti", {
        plugins: ['remove_button'],
        placeholder: "Giocatori da richiedere",
        create: false,
        maxItems: 0
    });
    selectRichiesti.disable();

    // Prestiti selects (single item)
    const selectPrestito1Rich = new TomSelect('#prestito1_richiesto', { placeholder: "Seleziona giocatore", maxItems: 1, create: false });
    const selectPrestito1Off = new TomSelect('#prestito1_offerto', { placeholder: "Seleziona giocatore", maxItems: 1, create: false });
    const selectPrestito2Rich = new TomSelect('#prestito2_richiesto', { placeholder: "Seleziona giocatore", maxItems: 1, create: false });
    const selectPrestito2Off = new TomSelect('#prestito2_offerto', { placeholder: "Seleziona giocatore", maxItems: 1, create: false });

    selectPrestito1Rich.disable();
    selectPrestito1Off.disable();
    selectPrestito2Rich.disable();
    selectPrestito2Off.disable();

    const prestito1Fields = [
        selectPrestito1Rich, selectPrestito1Off,
        document.getElementById('prestito1_tipo_richiesto'),
        document.getElementById('prestito1_tipo_offerto'),
        document.getElementById('prestito1_riscatto_richiesto'),
        document.getElementById('prestito1_riscatto_offerto')
    ];

    const prestito2Fields = [
        selectPrestito2Rich, selectPrestito2Off,
        document.getElementById('prestito2_tipo_richiesto'),
        document.getElementById('prestito2_tipo_offerto'),
        document.getElementById('prestito2_riscatto_richiesto'),
        document.getElementById('prestito2_riscatto_offerto')
    ];

    const loan1Body = document.getElementById('loan1-body');
    const loan2Body = document.getElementById('loan2-body');

    // Helper to enable/disable a loan block
    function toggleLoan(blockFields, enabled) {
        blockFields.forEach(f => {
            if (f instanceof TomSelect) {
                if (enabled) { f.enable(); } else { f.disable(); f.clear(); }
            } else {
                f.disabled = !enabled;
                if (!enabled) f.value = '';
            }
        });
    }

    document.getElementById('enable_prestito1').addEventListener('change', (e) => {
        toggleLoan(prestito1Fields, e.target.checked);
        loan1Body.classList.toggle('d-none', !e.target.checked);
        updateSlotsCard();
    });
    document.getElementById('enable_prestito2').addEventListener('change', (e) => {
        toggleLoan(prestito2Fields, e.target.checked);
        loan2Body.classList.toggle('d-none', !e.target.checked);
        updateSlotsCard();
    });

    // Event listeners per bloccare riscatto a 0 se prestito √® secco
    function setupLoanTypeListener(tipoSelectId, riscattoSelectId) {
        const tipoSelect = document.getElementById(tipoSelectId);
        const riscattoInput = document.getElementById(riscattoSelectId);
        
        tipoSelect.addEventListener('change', () => {
            if (tipoSelect.value === 'Secco') {
                riscattoInput.value = '0';
                riscattoInput.disabled = true;
            } else {
                riscattoInput.disabled = false;
            }
        });
    }
    
    setupLoanTypeListener('prestito1_tipo_richiesto', 'prestito1_riscatto_richiesto');
    setupLoanTypeListener('prestito1_tipo_offerto', 'prestito1_riscatto_offerto');
    setupLoanTypeListener('prestito2_tipo_richiesto', 'prestito2_riscatto_richiesto');
    setupLoanTypeListener('prestito2_tipo_offerto', 'prestito2_riscatto_offerto');

    loan1Body.classList.toggle('d-none', !document.getElementById('enable_prestito1').checked);
    loan2Body.classList.toggle('d-none', !document.getElementById('enable_prestito2').checked);

    function updateMaxItems() {
        const destOption = selectSquadra.options[selectSquadra.selectedIndex];
        const destFreeSlots = destOption ? parseInt(destOption.dataset.slotLiberi) || 0 : 0;

        const maxRichiestiSuggeriti = selectOfferti.items.length + myFreeSlots;
        const maxOffertiSuggeriti = selectRichiesti.items.length + destFreeSlots;

        selectRichiesti.settings.maxItems = 30;
        selectOfferti.settings.maxItems = 30;

        maxOffertiSpan.textContent = maxOffertiSuggeriti;
        maxRichiestiSpan.textContent = maxRichiestiSuggeriti;

        // Controlla disponibilit√† slot prestiti
        checkLoanSlotsAvailability();
    }

    function checkLoanSlotsAvailability() {
        const destOption = selectSquadra.options[selectSquadra.selectedIndex];
        const destSlotPrestiti = destOption ? parseInt(destOption.dataset.slotPrestiti) || 0 : 0;

        const enable_prestito1 = document.getElementById('enable_prestito1');
        const enable_prestito2 = document.getElementById('enable_prestito2');
        
        // Le checkbox non vengono mai disabilitate
        enable_prestito1.disabled = false;
        enable_prestito2.disabled = false;
        
        // Calcola slot liberi per ciascuna squadra
        const myFreeSlots = 2 - mySlotPrestiti;  // 2 = nessun occupato, 1 = uno occupato, 0 = tutti occupati
        const destFreeSlots = 2 - destSlotPrestiti;
        
        // Prestito 1 OFFERTO: abilitato se ho almeno 1 slot libero (myFreeSlots >= 1)
        const prestito1OffDisabled = myFreeSlots < 1;
        // Prestito 2 OFFERTO: abilitato solo se ho 2 slot liberi (myFreeSlots >= 2)
        const prestito2OffDisabled = myFreeSlots < 2;
        
        // Prestito 1 RICHIESTO: abilitato se controparte ha almeno 1 slot libero
        const prestito1RichDisabled = destFreeSlots < 1;
        // Prestito 2 RICHIESTO: abilitato solo se controparte ha 2 slot liberi
        const prestito2RichDisabled = destFreeSlots < 2;
        
        // Disabilita pannelli e campi PRESTITO 1 OFFERTO
        const tradeSidePrestito1Off = document.getElementById('trade-side-prestito1-offerto');
        const prestito1Off = document.getElementById('prestito1_offerto');
        const prestito1TipoOff = document.getElementById('prestito1_tipo_offerto');
        const prestito1RiscattoOff = document.getElementById('prestito1_riscatto_offerto');
        
        if (prestito1OffDisabled) {
            tradeSidePrestito1Off.classList.add('disabled-section');
            prestito1Off.disabled = true;
            prestito1TipoOff.disabled = true;
            prestito1RiscattoOff.disabled = true;
        } else {
            tradeSidePrestito1Off.classList.remove('disabled-section');
            prestito1Off.disabled = false;
            prestito1TipoOff.disabled = false;
            prestito1RiscattoOff.disabled = false;
        }
        
        // Disabilita pannelli e campi PRESTITO 1 RICHIESTO
        const tradeSidePrestito1Rich = document.getElementById('trade-side-prestito1-richiesto');
        const prestito1Rich = document.getElementById('prestito1_richiesto');
        const prestito1TipoRich = document.getElementById('prestito1_tipo_richiesto');
        const prestito1RiscattoRich = document.getElementById('prestito1_riscatto_richiesto');
        
        if (prestito1RichDisabled) {
            tradeSidePrestito1Rich.classList.add('disabled-section');
            prestito1Rich.disabled = true;
            prestito1TipoRich.disabled = true;
            prestito1RiscattoRich.disabled = true;
        } else {
            tradeSidePrestito1Rich.classList.remove('disabled-section');
            prestito1Rich.disabled = false;
            prestito1TipoRich.disabled = false;
            prestito1RiscattoRich.disabled = false;
        }
        
        // Disabilita pannelli e campi PRESTITO 2 OFFERTO
        const tradeSidePrestito2Off = document.getElementById('trade-side-prestito2-offerto');
        const prestito2Off = document.getElementById('prestito2_offerto');
        const prestito2TipoOff = document.getElementById('prestito2_tipo_offerto');
        const prestito2RiscattoOff = document.getElementById('prestito2_riscatto_offerto');
        
        if (prestito2OffDisabled) {
            tradeSidePrestito2Off.classList.add('disabled-section');
            prestito2Off.disabled = true;
            prestito2TipoOff.disabled = true;
            prestito2RiscattoOff.disabled = true;
        } else {
            tradeSidePrestito2Off.classList.remove('disabled-section');
            prestito2Off.disabled = false;
            prestito2TipoOff.disabled = false;
            prestito2RiscattoOff.disabled = false;
        }
        
        // Disabilita pannelli e campi PRESTITO 2 RICHIESTO
        const tradeSidePrestito2Rich = document.getElementById('trade-side-prestito2-richiesto');
        const prestito2Rich = document.getElementById('prestito2_richiesto');
        const prestito2TipoRich = document.getElementById('prestito2_tipo_richiesto');
        const prestito2RiscattoRich = document.getElementById('prestito2_riscatto_richiesto');
        
        if (prestito2RichDisabled) {
            tradeSidePrestito2Rich.classList.add('disabled-section');
            prestito2Rich.disabled = true;
            prestito2TipoRich.disabled = true;
            prestito2RiscattoRich.disabled = true;
        } else {
            tradeSidePrestito2Rich.classList.remove('disabled-section');
            prestito2Rich.disabled = false;
            prestito2TipoRich.disabled = false;
            prestito2RiscattoRich.disabled = false;
        }
        
        // Mostra/nascondi messaggi di avvertenza
        let warningMsg = document.getElementById('loan-slots-warning');
        const hasWarnings = myFreeSlots === 0 || destFreeSlots === 0 || myFreeSlots === 1 || destFreeSlots === 1;
        
        if (hasWarnings) {
            let warningText = '‚ö†Ô∏è ';
            if (myFreeSlots === 0) {
                warningText += `${nome_squadra} non pu√≤ ricevere altri prestiti (slot: ${mySlotPrestiti}/2). `;
            } else if (myFreeSlots === 1) {
                warningText += `${nome_squadra} pu√≤ ricevere solo 1 prestito (slot: ${mySlotPrestiti}/2). `;
            }
            
            if (destFreeSlots === 0) {
                const destName = selectSquadra.value || 'Squadra destinataria';
                warningText += `${destName} non pu√≤ ricevere altri prestiti (slot: ${destSlotPrestiti}/2).`;
            } else if (destFreeSlots === 1) {
                const destName = selectSquadra.value || 'Squadra destinataria';
                warningText += `${destName} pu√≤ ricevere solo 1 prestito (slot: ${destSlotPrestiti}/2).`;
            }
            
            if (!warningMsg) {
                warningMsg = document.createElement('div');
                warningMsg.id = 'loan-slots-warning';
                warningMsg.className = 'alert alert-warning mb-3';
                warningMsg.innerHTML = warningText;
                
                const step3 = document.getElementById('step-3');
                const cardBody = step3.querySelector('.card-body');
                cardBody.insertBefore(warningMsg, cardBody.firstChild.nextSibling);
            } else {
                warningMsg.innerHTML = warningText;
            }
        } else {
            if (warningMsg) {
                warningMsg.remove();
            }
        }
    }

    function updateSlotsCard() {
        const destOption = selectSquadra.options[selectSquadra.selectedIndex];
        const destFreeSlots = destOption ? parseInt(destOption.dataset.slotLiberi) || 0 : null;
        const destCreditsAvail = destOption ? parseInt(destOption.dataset.maxCrediti) || 0 : null;
        const destSlotPrestiti = destOption ? parseInt(destOption.dataset.slotPrestiti) || 0 : 0;

        const scambioOfferti = selectOfferti.items.length;
        const scambioRichiesti = selectRichiesti.items.length;

        const loan1Active = document.getElementById('enable_prestito1').checked;
        const loan2Active = document.getElementById('enable_prestito2').checked;

        const loanRichiesti = (loan1Active ? selectPrestito1Rich.items.length : 0) + (loan2Active ? selectPrestito2Rich.items.length : 0);
        const loanOfferti = (loan1Active ? selectPrestito1Off.items.length : 0) + (loan2Active ? selectPrestito2Off.items.length : 0);

        const loanOffertiSlotDelta = (loan1Active ? selectPrestito1Off.items : []).concat(loan2Active ? selectPrestito2Off.items : [])
            .filter(id => {
                const tipo = contractById.get(String(id));
                return tipo === 'Indeterminato' || tipo === 'Hold';
            }).length;

        const loanRichiestiSlotDelta = (loan1Active ? selectPrestito1Rich.items : []).concat(loan2Active ? selectPrestito2Rich.items : [])
            .filter(id => {
                const tipo = contractById.get(String(id));
                return tipo === 'Indeterminato' || tipo === 'Hold';
            }).length;

        const creditiOfferti = parseInt(creditiOffertiInput.value) || 0;
        const creditiRichiesti = parseInt(creditiRichiestiInput.value) || 0;

        const mieiOra = 30 - myFreeSlots;
        const destOra = destFreeSlots === null ? null : 30 - destFreeSlots;

        const mieiDopo = mieiOra - scambioOfferti + scambioRichiesti - loanOffertiSlotDelta;
        const destDopo = destOra === null ? null : destOra - scambioRichiesti + scambioOfferti - loanRichiestiSlotDelta;
        
        // Calcolo slot prestiti - usa i valori reali dal backend
        const mieiPrestitiOra = mySlotPrestiti;
        const destPrestitiOra = destSlotPrestiti;
        
        // Dopo lo scambio: prestiti attuali + nuovi prestiti dal form
        const mieiPrestitiDopo = mieiPrestitiOra + loanRichiesti;
        const destPrestitiDopo = destPrestitiOra + loanOfferti;

        const mieiCredOra = myCreditsAvailable;
        const destCredOra = destCreditsAvail === null ? null : destCreditsAvail;

        const mieiCredDopo = mieiCredOra - creditiOfferti + creditiRichiesti;
        const destCredDopo = destCredOra === null ? null : destCredOra - creditiRichiesti + creditiOfferti;

        myOccupiedSpan.textContent = mieiOra + ' / 30';
        destOccupiedSpan.textContent = destOra === null ? '‚Äî' : destOra + ' / 30';
        myOccupiedAfterSpan.textContent = isNaN(mieiDopo) ? '‚Äî' : mieiDopo + ' / 30';
        destOccupiedAfterSpan.textContent = destDopo === null || isNaN(destDopo) ? '‚Äî' : destDopo + ' / 30';
        
        myPrestitiSpan.textContent = mieiPrestitiOra + ' / 2';
        myPrestitiAfterSpan.textContent = mieiPrestitiDopo + ' / 2';
        destPrestitiSpan.textContent = destPrestitiOra + ' / 2';
        destPrestitiAfterSpan.textContent = destPrestitiDopo + ' / 2';

        myCreditsSpan.textContent = mieiCredOra;
        myCreditsAfterSpan.textContent = isNaN(mieiCredDopo) ? '‚Äî' : mieiCredDopo;
        destCreditsSpan.textContent = destCredOra === null ? '‚Äî' : destCredOra;
        destCreditsAfterSpan.textContent = destCredDopo === null || isNaN(destCredDopo) ? '‚Äî' : destCredDopo;

        if (mobileMieiSlotAfter) {
            mobileMieiSlotAfter.textContent = isNaN(mieiDopo) ? '‚Äî' : `${mieiDopo} / 30`;
        }
        if (mobileMieiCredAfter) {
            mobileMieiCredAfter.textContent = isNaN(mieiCredDopo) ? '‚Äî' : mieiCredDopo;
        }
        if (mobileDestSlotAfter) {
            mobileDestSlotAfter.textContent = destDopo === null || isNaN(destDopo) ? '‚Äî' : `${destDopo} / 30`;
        }
        if (mobileDestCredAfter) {
            mobileDestCredAfter.textContent = destCredDopo === null || isNaN(destCredDopo) ? '‚Äî' : destCredDopo;
        }
    }

    selectOfferti.on('change', () => { updateMaxItems(); updateSlotsCard(); });
    selectRichiesti.on('change', () => { updateMaxItems(); updateSlotsCard(); });
    selectPrestito1Rich.on('change', updateSlotsCard);
    selectPrestito1Off.on('change', updateSlotsCard);
    selectPrestito2Rich.on('change', updateSlotsCard);
    selectPrestito2Off.on('change', updateSlotsCard);
    creditiOffertiInput.addEventListener('input', updateSlotsCard);
    creditiRichiestiInput.addEventListener('input', updateSlotsCard);

    selectSquadra.addEventListener('change', () => {
        const squadraSelezionata = selectSquadra.value;
        const selectedOption = selectSquadra.options[selectSquadra.selectedIndex];

        selectRichiesti.clearOptions();
        selectPrestito1Rich.clearOptions();
        selectPrestito2Rich.clearOptions();

        if (!squadraSelezionata) {
            selectRichiesti.disable();
            selectPrestito1Rich.disable();
            selectPrestito2Rich.disable();
            creditiRichiestiInput.disabled = true;
            maxRichiestiSpan.textContent = 0;
            destTeamLabel.textContent = 'Controparte';
                        document.getElementById('crediti-richiesti-max-badge').textContent = 'Max: 0';
            updateMaxItems();
            updateSlotsCard();
            return;
        }

        destTeamLabel.textContent = squadraSelezionata;
        if (mobileDestTeam) {
            mobileDestTeam.textContent = squadraSelezionata;
        }

        const filtrati = allOptions.filter(g => g.squadra_att === squadraSelezionata);
        filtrati.forEach(g => {
            selectRichiesti.addOption({ value: g.id, text: g.nome });
            selectPrestito1Rich.addOption({ value: g.id, text: g.nome });
            selectPrestito2Rich.addOption({ value: g.id, text: g.nome });
        });

        selectRichiesti.enable();
        selectPrestito1Rich.enable();
        selectPrestito2Rich.enable();

        selectRichiesti.refreshOptions(false);
        selectPrestito1Rich.refreshOptions(false);
        selectPrestito2Rich.refreshOptions(false);

        const maxCrediti = selectedOption.dataset.maxCrediti || 0;
        creditiRichiestiInput.disabled = false;
        creditiRichiestiInput.max = maxCrediti;
        creditiRichiestiInput.value = '';
        creditiRichiestiInput.placeholder = `Max: ${maxCrediti}`;
        document.getElementById('crediti-richiesti-max-badge').textContent = `Max: ${maxCrediti}`;
        
        // Update step indicators
        document.querySelectorAll('.step-number').forEach((step, index) => {
            if (index === 0) step.classList.add('active');
        });
        document.getElementById('step-1').classList.add('active');

        updateMaxItems();
        updateSlotsCard();
        checkLoanSlotsAvailability();
    });

    form.addEventListener('submit', (event) => {
        const selectedOption = selectSquadra.options[selectSquadra.selectedIndex];
        if (!selectedOption) {
            event.preventDefault();
            alert('Seleziona una squadra destinataria.');
            return;
        }

        const destFreeSlots = parseInt(selectedOption.dataset.slotLiberi) || 0;
        const mieiAttuali = 30 - myFreeSlots;
        const destAttuali = 30 - destFreeSlots;

        const scambioOfferti = selectOfferti.items.length;
        const scambioRichiesti = selectRichiesti.items.length;

        const loan1Active = document.getElementById('enable_prestito1').checked;
        const loan2Active = document.getElementById('enable_prestito2').checked;
        const loanRichiesti = (loan1Active ? selectPrestito1Rich.items.length : 0) + (loan2Active ? selectPrestito2Rich.items.length : 0);
        const loanOfferti = (loan1Active ? selectPrestito1Off.items.length : 0) + (loan2Active ? selectPrestito2Off.items.length : 0);

        const loanOffertiSlotDelta = (loan1Active ? selectPrestito1Off.items : []).concat(loan2Active ? selectPrestito2Off.items : [])
            .filter(id => {
                const tipo = contractById.get(String(id));
                return tipo === 'Indeterminato' || tipo === 'Hold';
            }).length;

        const loanRichiestiSlotDelta = (loan1Active ? selectPrestito1Rich.items : []).concat(loan2Active ? selectPrestito2Rich.items : [])
            .filter(id => {
                const tipo = contractById.get(String(id));
                return tipo === 'Indeterminato' || tipo === 'Hold';
            }).length;

        const mieiDopo = mieiAttuali - scambioOfferti + scambioRichiesti - loanOffertiSlotDelta;
        const destDopo = destAttuali - scambioRichiesti + scambioOfferti - loanRichiestiSlotDelta;

        if (mieiDopo > 30 || destDopo > 30) {
            event.preventDefault();
            alert('La trattativa supera il limite di 30 slot per una delle squadre.');
            return;
        }
    });

    // Init
    maxOffertiSpan.textContent = selectOfferti.options.length;
    maxRichiestiSpan.textContent = myFreeSlots;
    myOccupiedSpan.textContent = 30 - myFreeSlots;
    myCreditsSpan.textContent = myCreditsAvailable;
    myCreditsAfterSpan.textContent = myCreditsAvailable;
    updateMaxItems();
    updateSlotsCard();
});
</script>

{% endblock %}