{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">

    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <div>
            <h1 class="mb-0">Nuova proposta di scambio</h1>
            <small class="text-muted">Squadra: <strong>{{ nome_squadra }}</strong></small>
        </div>
        <a href="{{ url_for('mercato.user_mercato', nome_squadra=nome_squadra) }}" 
           class="btn btn-outline-secondary btn-lg mt-2 mt-sm-0">
            ← Torna al mercato
        </a>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-md-6">
            <div class="card slot-card shadow-sm bg-light border-0 h-100">
                <div class="card-body py-3">
                    <p class="slot-label mb-2">Slot e crediti ({{ nome_squadra }})</p>
                    <div class="d-flex flex-wrap align-items-baseline gap-3 justify-content-center">
                        <div class="text-center">
                            <p class="slot-subtitle mb-1">Slot att.</p>
                            <p class="slot-value mb-0" id="card-miei-slot">—</p>
                        </div>
                        <div class="border-start ps-3 text-center">
                            <p class="slot-subtitle mb-1">Slot post</p>
                            <p class="slot-value mb-0" id="card-miei-slot-after">—</p>
                        </div>
                        <div class="border-start ps-3 text-center">
                            <p class="slot-subtitle mb-1">Crediti att.</p>
                            <p class="slot-value mb-0" id="card-miei-crediti">—</p>
                        </div>
                        <div class="border-start ps-3 text-center">
                            <p class="slot-subtitle mb-1">Crediti post</p>
                            <p class="slot-value mb-0" id="card-miei-crediti-after">—</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card slot-card shadow-sm bg-light border-0 h-100">
                <div class="card-body py-3">
                    <p class="slot-label mb-2">Slot e crediti (<span id="card-dest-team">Seleziona squadra</span>)</p>
                    <div class="d-flex flex-wrap align-items-baseline gap-3 justify-content-center">
                        <div class="text-center">
                            <p class="slot-subtitle mb-1">Slot att.</p>
                            <p class="slot-value mb-0" id="card-dest-slot">—</p>
                        </div>
                        <div class="border-start ps-3 text-center">
                            <p class="slot-subtitle mb-1">Slot post</p>
                            <p class="slot-value mb-0" id="card-dest-slot-after">—</p>
                        </div>
                        <div class="border-start ps-3 text-center">
                            <p class="slot-subtitle mb-1">Crediti att.</p>
                            <p class="slot-value mb-0" id="card-dest-crediti">—</p>
                        </div>
                        <div class="border-start ps-3 text-center">
                            <p class="slot-subtitle mb-1">Crediti post</p>
                            <p class="slot-value mb-0" id="card-dest-crediti-after">—</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <form method="POST" action="{{ url_for('mercato.nuovo_scambio', nome_squadra=nome_squadra) }}" 
                data-slot-liberi-miei="{{ slot_liberi_miei }}" 
                data-crediti-miei="{{ crediti_effettivi }}">
                <div class="mb-3">
                    <label for="squadra_destinataria" class="form-label fw-semibold">Squadra destinataria</label>
                    <select id="squadra_destinataria" name="squadra_destinataria" class="form-select" required>
                        <option value="" selected disabled>Seleziona squadra</option>
                        {% for s in squadre %}
                            {% if s.nome != nome_squadra %}
                                <option value="{{ s.nome }}" 
                                        data-max-crediti="{{ s.offerta_massima_possibile }}"
                                        data-slot-liberi="{{ s.slot_liberi }}">
                                    {{ s.nome }}
                                </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="crediti_offerti" class="form-label">Crediti offerti</label>
                        <input type="number" min="0" name="crediti_offerti" id="crediti_offerti" class="form-control"
                                 max="{{ crediti_effettivi }}" placeholder="Max: {{ crediti_effettivi }}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="crediti_richiesti" class="form-label">Crediti richiesti</label>
                        <input type="number" min="0" name="crediti_richiesti" id="crediti_richiesti" class="form-control" disabled>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="giocatori_offerti" class="form-label">Giocatori offerti (Max: <span id="max_offerti">{{ miei_giocatori|length }}</span>)</label> <select multiple name="giocatori_offerti" id="giocatori_offerti" class="form-select">
                            {% for g in miei_giocatori %}
                                <option value="{{ g.id }}">{{ g.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="giocatori_richiesti" class="form-label">Giocatori richiesti (Max: <span id="max_richiesti">0</span>)</label> <select multiple name="giocatori_richiesti" id="giocatori_richiesti" class="form-select" disabled></select>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="messaggio" class="form-label">Messaggio (opzionale)</label>
                    <textarea name="messaggio" id="messaggio" class="form-control" rows="3"></textarea>
                </div>

                <button type="submit" class="btn btn-primary w-100 py-2">Invia proposta di scambio</button>
            </form>
        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>


<script>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector('form');
    const myFreeSlots = parseInt(form.dataset.slotLiberiMiei) || 0;
    const myCreditsAvailable = parseInt(form.dataset.creditiMiei) || 0;
    const myOccupiedSpan = document.getElementById('card-miei-slot');
    const destOccupiedSpan = document.getElementById('card-dest-slot');
    const myOccupiedAfterSpan = document.getElementById('card-miei-slot-after');
    const destOccupiedAfterSpan = document.getElementById('card-dest-slot-after');
    const myCreditsSpan = document.getElementById('card-miei-crediti');
    const myCreditsAfterSpan = document.getElementById('card-miei-crediti-after');
    const destCreditsSpan = document.getElementById('card-dest-crediti');
    const destCreditsAfterSpan = document.getElementById('card-dest-crediti-after');
    const creditiOffertiInput = document.getElementById('crediti_offerti');
    const creditiRichiestiInput = document.getElementById('crediti_richiesti');
    
    // Elementi per aggiornare la UI
    const maxOffertiSpan = document.getElementById('max_offerti');
    const maxRichiestiSpan = document.getElementById('max_richiesti');
    
    // Aggiorna l'etichetta per i giocatori offerti (la squadra otterrà N giocatori e cederà M. La differenza M-N deve essere <= myFreeSlots)
    // Per semplicità, inizialmente limitiamo le offerte al numero di giocatori che POTREI ricevere, ovvero myFreeSlots
    // Un controllo più preciso avverrà alla selezione. Il max iniziale è il numero massimo di giocatori che la mia squadra è disposta ad accettare.
    maxOffertiSpan.textContent = myFreeSlots;

    const selectOfferti = new TomSelect("#giocatori_offerti", {
        plugins: ['remove_button'],
        placeholder: "Seleziona giocatori da offrire...",
        create: false,
        // Limita il numero di selezioni che POTREBBERO essere offerte.
        // La validazione vera è sulla combinazione offerti/richiesti. Qui è un limite di usabilità.
            maxItems: 30, // Impostiamo un limite alto di default, la validazione avviene al change/submit
    });

    const selectRichiesti = new TomSelect("#giocatori_richiesti", {
        plugins: ['remove_button'],
        placeholder: "Seleziona giocatori da richiedere...",
        create: false,
        maxItems: 0, // Inizialmente 0, verrà aggiornato
    });

    selectRichiesti.disable();

    const selectSquadra = document.getElementById("squadra_destinataria");
    const creditiRichiesti = document.getElementById("crediti_richiesti");

    // Usa JSON per generare l'array JS in modo sicuro
    const allOptions = JSON.parse('{{ giocatori|tojson|safe }}');

    // Funzione di validazione per i maxItems
    function updateMaxItems() {
        const selectedOfferti = selectOfferti.items.length;
        const selectedRichiesti = selectRichiesti.items.length;

        const destOption = selectSquadra.options[selectSquadra.selectedIndex];
        const destFreeSlots = destOption ? parseInt(destOption.dataset.slotLiberi) || 0 : 0;

        // Limiti suggeriti (non bloccanti) basati sul saldo posti disponibili
        const maxRichiestiSuggeriti = selectedOfferti + myFreeSlots;
        const maxOffertiSuggeriti = selectedRichiesti + destFreeSlots;

        // Consenti la selezione anche quando le squadre sono piene; la validazione finale avviene al submit
        selectRichiesti.settings.maxItems = 30;
        selectOfferti.settings.maxItems = 30;

        // Aggiorna le etichette informative
        maxOffertiSpan.textContent = maxOffertiSuggeriti;
        maxRichiestiSpan.textContent = maxRichiestiSuggeriti;
    }

    function updateSlotsCard() {
        const destOption = selectSquadra.options[selectSquadra.selectedIndex];
        const destFreeSlots = destOption ? parseInt(destOption.dataset.slotLiberi) || 0 : null;
        const destCreditsAvail = destOption ? parseInt(destOption.dataset.maxCrediti) || 0 : null;

        const selectedOfferti = selectOfferti.items.length;
        const selectedRichiesti = selectRichiesti.items.length;
        const creditiOfferti = parseInt(creditiOffertiInput.value) || 0;
        const creditiRichiesti = parseInt(creditiRichiestiInput.value) || 0;

        const mieiOra = 30 - myFreeSlots;
        const destOra = destFreeSlots === null ? null : 30 - destFreeSlots;

        const mieiDopo = mieiOra - selectedOfferti + selectedRichiesti;
        const destDopo = destOra === null ? null : destOra - selectedRichiesti + selectedOfferti;

        const mieiCredOra = myCreditsAvailable;
        const destCredOra = destCreditsAvail === null ? null : destCreditsAvail;

        const mieiCredDopo = mieiCredOra - creditiOfferti + creditiRichiesti;
        const destCredDopo = destCredOra === null ? null : destCredOra - creditiRichiesti + creditiOfferti;

        myOccupiedSpan.textContent = mieiOra;
        myOccupiedAfterSpan.textContent = isNaN(mieiDopo) ? '—' : mieiDopo;
        destOccupiedSpan.textContent = destOra === null ? '—' : destOra;
        destOccupiedAfterSpan.textContent = destDopo === null || isNaN(destDopo) ? '—' : destDopo;

        myCreditsSpan.textContent = mieiCredOra;
        myCreditsAfterSpan.textContent = isNaN(mieiCredDopo) ? '—' : mieiCredDopo;
        destCreditsSpan.textContent = destCredOra === null ? '—' : destCredOra;
        destCreditsAfterSpan.textContent = destCredDopo === null || isNaN(destCredDopo) ? '—' : destCredDopo;
    }
    
    // Ascoltatori per il cambiamento delle selezioni
    selectOfferti.on('change', updateMaxItems);
    selectRichiesti.on('change', updateMaxItems);
    selectOfferti.on('change', updateSlotsCard);
    selectRichiesti.on('change', updateSlotsCard);
    creditiOffertiInput.addEventListener('input', updateSlotsCard);
    creditiRichiestiInput.addEventListener('input', updateSlotsCard);
    
    // Inizializza con i miei slot liberi come limite iniziale massimo
    // Il limite è sul *saldo* dei giocatori. L'utente non può richiedere più di (giocatori offerti + miei slot liberi)
    selectOfferti.settings.maxItems = 30; // Max tutti i miei giocatori
    selectRichiesti.settings.maxItems = 30;
    maxOffertiSpan.textContent = selectOfferti.options.length; // Max tutti i miei giocatori
    maxRichiestiSpan.textContent = myFreeSlots; // Max iniziali (se offro 0)
    updateSlotsCard();


    selectSquadra.addEventListener("change", () => {
        const squadraSelezionata = selectSquadra.value;
        const selectedOption = selectSquadra.options[selectSquadra.selectedIndex];
        const destFreeSlots = parseInt(selectedOption.dataset.slotLiberi) || 0;
        
        const destTeamSpan = document.getElementById('card-dest-team');

        selectRichiesti.clearOptions();
        selectRichiesti.clear(); // Pulisce i valori selezionati
        
        if (!squadraSelezionata) {
            selectRichiesti.disable();
            creditiRichiesti.disabled = true;
            maxRichiestiSpan.textContent = 0;
            destTeamSpan.textContent = 'Seleziona squadra';
            updateMaxItems();
            return;
        }
        
        // Aggiorna il nome della squadra nel card
        destTeamSpan.textContent = squadraSelezionata;

        // Filtra solo i giocatori della squadra selezionata
        const filtrati = allOptions.filter(g => g.squadra_att === squadraSelezionata);
        filtrati.forEach(g => selectRichiesti.addOption({value: g.id, text: g.nome}));

        selectRichiesti.enable();
        selectRichiesti.refreshOptions(false);

        // Imposta max crediti richiesti
        const maxCrediti = selectedOption.dataset.maxCrediti || 0;
        creditiRichiesti.disabled = false;
        creditiRichiesti.max = maxCrediti;
        creditiRichiesti.value = "";
        creditiRichiesti.placeholder = `Max: ${maxCrediti}`;

        // Aggiorna il limite per i giocatori richiesti basato sui nuovi slot liberi della squadra destinataria
        // e ricalcola il limite anche per i giocatori offerti.
        updateMaxItems();
        updateSlotsCard();
    });
    
    form.addEventListener("submit", (event) => {
        const selectedOption = selectSquadra.options[selectSquadra.selectedIndex];
        if (!selectedOption) {
            event.preventDefault();
            alert("Seleziona una squadra destinataria.");
            return;
        }

        const selectedOfferti = selectOfferti.items.length;
        const selectedRichiesti = selectRichiesti.items.length;
        const destFreeSlots = parseInt(selectedOption.dataset.slotLiberi) || 0;

        const mieiAttuali = 30 - myFreeSlots;
        const destAttuali = 30 - destFreeSlots;

        const mieiDopo = mieiAttuali - selectedOfferti + selectedRichiesti;
        const destDopo = destAttuali - selectedRichiesti + selectedOfferti;

        if (mieiDopo > 30 || destDopo > 30) {
            event.preventDefault();
            alert("Lo scambio non rispetta il limite di 30 slot: regola le selezioni di giocatori.");
            return;
        }
    });
    
    // Chiamata iniziale per impostare i limiti e le etichette
    updateMaxItems(); 
    updateSlotsCard();
});
</script>

{% endblock %}